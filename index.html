<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon202.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSK7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>–ü–∞—Ä—Å–µ—Ä NBA 2K + –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #222;
            --primary: #3182ce;
            --border-color: #ddd;
            --success-bg: #c6f6d5;
            --success-color: #22543d;
            --error-bg: #fed7d7;
            --error-color: #c53030;
        }
        [data-theme="dark"] {
            --bg-color: #2d3748;
            --container-bg: #4a5568;
            --text-color: #f7fafc;
            --primary: #63b3ed;
            --border-color: #718096;
            --success-bg: #22543d;
            --success-color: #c6f6d5;
            --error-bg: #c53030;
            --error-color: #fed7d7;
        }
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            margin: 0;
            padding: 12px;
            color: var(--text-color);
            background: var(--bg-color);
            line-height: 1.3;
            touch-action: manipulation;
        }
        .container {
            background: var(--container-bg);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        h1 {
            font-size: 18px;
            margin: 0;
            color: var(--primary);
        }
        .header-controls {
            display: flex;
            gap: 8px;
        }
        .theme-toggle, .clear-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            padding: 6px;
            border-radius: 6px;
            background: rgba(0,0,0,0.05);
        }
        .clear-btn {
            font-size: 16px;
            padding: 6px 8px;
        }
        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        input[type=file] {
            cursor: pointer;
            flex: 1;
            min-width: 0;
            font-size: 14px;
        }
        button {
            padding: 8px 12px;
            border: 0;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            flex-shrink: 0;
            font-size: 14px;
        }
        button:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
        #preview {
            max-width: 100%;
            border: 1px solid var(--border-color);
            margin: 8px 0;
            display: block;
            border-radius: 6px;
        }
        .log {
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            max-height: 150px;
            overflow-y: auto;
            margin: 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
            font-size: 13px;
        }
        td, th {
            border: 1px solid var(--border-color);
            padding: 4px 6px;
            text-align: left;
        }
        th {
            background: rgba(0,0,0,0.05);
        }
        .small {
            font-size: 11px;
            color: var(--text-color);
            opacity: 0.7;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 12px 0;
        }
        .stat-card {
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            padding: 8px;
            border-left: 3px solid var(--primary);
        }
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
        }
        .stat-label {
            font-size: 11px;
            opacity: 0.8;
        }
        .prediction {
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid var(--primary);
        }
        .prediction-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .prediction-value {
            font-size: 20px;
            font-weight: bold;
        }
        .section {
            margin: 16px 0;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }
        .error {
            background: var(--error-bg);
            color: var(--error-color);
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 13px;
        }
        .success {
            background: var(--success-bg);
            color: var(--success-color);
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 13px;
        }
        .edit-section {
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }
        .edit-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .edit-input {
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--container-bg);
            color: var(--text-color);
            width: 50px;
            text-align: center;
            font-size: 14px;
        }
        .edit-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .edit-team {
            margin-bottom: 10px;
        }
        .edit-team-name {
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .edit-scores {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        .edit-format, .edit-time {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .time-display {
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            font-size: 13px;
        }
        .time-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .time-label {
            font-weight: bold;
        }
        .time-value {
            font-weight: bold;
        }
        .keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--container-bg);
            border-top: 1px solid var(--border-color);
            padding: 6px;
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            z-index: 1000;
            height: 180px;
        }
        .keyboard button {
            padding: 10px 2px;
            font-size: 16px;
            background: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 38px;
        }
        .keyboard-close {
            grid-column: span 4;
            margin-top: 6px;
            background: var(--primary) !important;
            color: white !important;
        }
        .keyboard-active {
            background: var(--primary) !important;
            color: white !important;
        }
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            .container {
                padding: 10px;
            }
            h1 {
                font-size: 16px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
            }
            button {
                width: 100%;
                padding: 10px;
            }
            .edit-format, .edit-time {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            .edit-input {
                width: 100%;
            }
            .keyboard {
                height: 160px;
                grid-template-columns: repeat(4, 1fr);
                gap: 3px;
            }
            .keyboard button {
                min-height: 36px;
                font-size: 14px;
                padding: 8px 2px;
            }
            .section {
                margin: 12px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ü–∞—Ä—Å–µ—Ä NBA 2K + –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
            <div class="header-controls">
                <button class="clear-btn" id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ">‚úï</button>
                <button class="theme-toggle" id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåô</button>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞</div>
            <div class="controls">
                <input id="file" type="file" accept="image/*">
                <button id="run" disabled>–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                <div id="status" class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
            </div>
            <img id="preview" alt="preview">
        </div>

        <div class="section">
            <div class="section-title">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</div>
            <div class="log" id="rawText">–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...</div>
        </div>

        <div class="section">
            <div class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞</div>
            <div id="parsed"></div>
        </div>

        <div class="section">
            <div class="section-title">–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</div>
            <div id="manualEdit"></div>
        </div>

        <div class="section">
            <div class="section-title">–†–∞—Å—á–µ—Ç —Ç–æ—Ç–∞–ª–æ–≤</div>
            <div id="calculations"></div>
        </div>
    </div>

    <div class="keyboard" id="keyboard">
        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button data-value="backspace">‚å´</button>
        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button data-value="0">0</button>
        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button data-value=":">:</button>
        <button data-value=".">.</button>
        <button data-value="-">-</button>
        <button class="keyboard-close" id="keyboardClose">–ì–æ—Ç–æ–≤–æ</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        const fileInput = document.getElementById('file');
        const preview = document.getElementById('preview');
        const runBtn = document.getElementById('run');
        const status = document.getElementById('status');
        const rawTextEl = document.getElementById('rawText');
        const parsedEl = document.getElementById('parsed');
        const manualEditEl = document.getElementById('manualEdit');
        const calculationsEl = document.getElementById('calculations');
        const themeToggle = document.getElementById('themeToggle');
        const clearBtn = document.getElementById('clearBtn');
        const keyboard = document.getElementById('keyboard');
        const keyboardClose = document.getElementById('keyboardClose');
        
        let currentImage = null;
        let currentParsedData = null;
        let activeInput = null;

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        clearBtn.addEventListener('click', () => {
            fileInput.value = '';
            preview.src = '';
            currentImage = null;
            runBtn.disabled = true;
            status.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            rawTextEl.textContent = '–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...';
            parsedEl.innerHTML = '';
            manualEditEl.innerHTML = '';
            calculationsEl.innerHTML = '';
            keyboard.style.display = 'none';
            activeInput = null;
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        themeToggle.addEventListener('click', () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? '' : 'dark');
            themeToggle.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã –∏–∑ localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            themeToggle.textContent = '‚òÄÔ∏è';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        document.querySelectorAll('.keyboard button[data-value]').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!activeInput) return;
                
                const value = e.target.getAttribute('data-value');
                if (value === 'backspace') {
                    activeInput.value = activeInput.value.slice(0, -1);
                } else {
                    activeInput.value += value;
                }
                
                // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ input –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤
                activeInput.dispatchEvent(new Event('input', { bubbles: true }));
            });
        });

        keyboardClose.addEventListener('click', () => {
            keyboard.style.display = 'none';
            activeInput = null;
        });

        // –°–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('edit-input') && 
                e.target.type !== 'number' && 
                e.target.type !== 'text' &&
                !keyboard.contains(e.target)) {
                keyboard.style.display = 'none';
                activeInput = null;
            }
        });

        // –ü–æ–∫–∞–∑ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.addEventListener('focusin', (e) => {
            if (e.target.classList.contains('edit-input') || 
                e.target.type === 'number' || 
                e.target.type === 'text') {
                e.preventDefault();
                activeInput = e.target;
                keyboard.style.display = 'grid';
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                activeInput.setAttribute('readonly', 'true');
                activeInput.blur(); // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        fileInput.addEventListener('change', e => {
            const f = e.target.files[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            preview.src = url;
            currentImage = f;
            runBtn.disabled = false;
            status.textContent = '–ì–æ—Ç–æ–≤–æ. –ù–∞–∂–º–∏ "–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å"';
            rawTextEl.textContent = '–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...';
            parsedEl.innerHTML = '';
            manualEditEl.innerHTML = '';
            calculationsEl.innerHTML = '';
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        runBtn.addEventListener('click', async () => {
            if (!currentImage) return;
            runBtn.disabled = true;
            status.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OCR...';
            rawTextEl.textContent = '...';

            try {
                status.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...';
                
                const { data: { text } } = await Tesseract.recognize(
                    currentImage,
                    'rus+eng',
                    { 
                        logger: m => {
                            if (m.status) status.textContent = m.status;
                        }
                    }
                );
                
                rawTextEl.textContent = text.trim();
                status.textContent = '–ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞...';

                const parsed = parseMatchText(text);
                currentParsedData = parsed;
                renderParsed(parsed);
                renderManualEdit(parsed);
                
                calculateAndDisplayTotals(parsed);

                status.textContent = '–ì–æ—Ç–æ–≤–æ';
            } catch (err) {
                console.error(err);
                status.textContent = '–û—à–∏–±–∫–∞: ' + (err.message || err);
                rawTextEl.textContent = (err.message || String(err));
            } finally {
                runBtn.disabled = false;
            }
        });

        // –§—É–Ω–∫—Ü–∏—è-–ø–∞—Ä—Å–µ—Ä: –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–∞
        function parseMatchText(text) {
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length>0);
            const result = { 
                rawLines: lines, 
                title: null, 
                timeBlock: null, 
                teams: [],
                format: '4x5',
                quarters: 4,
                minutesPerQuarter: 5
            };

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∏–≥—Ä—ã
            const joined = lines.join(' | ');
            
            // –ü–æ–∏—Å–∫ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ —à–∞–±–ª–æ–Ω—É (4x12 –º–∏–Ω) –∏–ª–∏ (4—Ö12 –º–∏–Ω)
            const formatMatch = joined.match(/\((\d+)\s*[x—Ö]\s*(\d+)\s*–º–∏–Ω\)/i);
            if (formatMatch) {
                const quarters = parseInt(formatMatch[1]);
                const minutes = parseInt(formatMatch[2]);
                result.format = `${quarters}x${minutes}`;
                result.quarters = quarters;
                result.minutesPerQuarter = minutes;
            } else if (joined.includes('4x4') || joined.includes('4√ó4') || /4\s*[x√ó]\s*4/.test(joined)) {
                result.format = '4x4';
                result.minutesPerQuarter = 4;
            } else if (joined.includes('4x5') || joined.includes('4√ó5') || /4\s*[x√ó]\s*5/.test(joined)) {
                result.format = '4x5';
                result.minutesPerQuarter = 5;
            }

            // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            for (const l of lines) {
                if (/NBA|–ö–∏–±–µ—Ä|ESports|ESport|ESportsBattle|–ö–∏–±–µ—Ä–±–∞—Å–∫–µ—Ç–±–æ–ª|–ë–∞—Å–∫–µ—Ç–±–æ–ª|IPBL/i.test(l)) {
                    result.title = l;
                    break;
                }
            }
            if (!result.title) result.title = lines[0] || '';

            // –ò—â–µ–º –≤—Ä–µ–º—è –∏ —á–µ—Ç–≤–µ—Ä—Ç—å
            const timeQuarterRegex = /(\d{1,2}:\d{2}).{0,30}?(\d+)-—è\s*—á–µ—Ç–≤–µ—Ä—Ç—å[^\d]*?([0-5]?\d:[0-5]?\d)/i;
            for (const l of lines) {
                const m = l.match(timeQuarterRegex);
                if (m) {
                    result.timeBlock = { clock: m[1], quarter: parseInt(m[2]), timeRemaining: m[3], raw: l };
                    break;
                }
            }
            
            // Fallback –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–µ—Ç–≤–µ—Ä—Ç–∏
            if (!result.timeBlock) {
                for (const l of lines) {
                    const m2 = l.match(/(\d{1,2}:\d{2}).{0,30}?([1-4])\s*[-]?\s*(—è)?\s*—á–µ—Ç–≤–µ—Ä—Ç—å[^\d]*?([0-5]?\d:[0-5]?\d)?/i);
                    if (m2) {
                        result.timeBlock = { clock: m2[1], quarter: parseInt(m2[2]), timeRemaining: (m2[4]||''), raw: l };
                        break;
                    }
                }
            }

            // –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫ —Å –æ—á–∫–∞–º–∏ –∫–æ–º–∞–Ω–¥
            let timeLineIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('—á–µ—Ç–≤–µ—Ä—Ç—å') && lines[i].match(/\d{1,2}:\d{2}/)) {
                    timeLineIndex = i;
                    break;
                }
            }
            
            if (timeLineIndex !== -1) {
                const potentialScoreLines = lines.slice(timeLineIndex + 1);
                
                const scoreLines = [];
                for (const line of potentialScoreLines) {
                    const numbers = line.match(/\d+/g);
                    if (numbers && numbers.length >= 3) {
                        const nums = numbers.map(n => parseInt(n, 10));
                        
                        if (nums.every(n => n >= 0 && n <= 200) && 
                            nums.length >= 3 && nums.length <= 4) {
                            
                            const nameMatch = line.split(/\d/)[0].trim();
                            let teamName = nameMatch;
                            
                            teamName = teamName.replace(/[=<>()]/g, '').trim();
                            
                            if (teamName.length < 2) {
                                const lineIndex = lines.indexOf(line);
                                if (lineIndex > 0) {
                                    const prevLine = lines[lineIndex - 1];
                                    if (!prevLine.match(/\d/) && !prevLine.includes('—á–µ—Ç–≤–µ—Ä—Ç—å')) {
                                        teamName = prevLine.replace(/[=<>()]/g, '').trim();
                                    }
                                }
                            }
                            
                            if (!teamName || teamName.length < 2) {
                                teamName = `–ö–æ–º–∞–Ω–¥–∞ ${scoreLines.length + 1}`;
                            }
                            
                            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–°–ï–ì–î–ê –°–£–ú–ú–ò–†–£–ï–ú –û–ß–ö–ò –ü–û –ß–ï–¢–í–ï–†–¢–Ø–ú –î–õ–Ø –û–ë–©–ï–ì–û –°–ß–ï–¢–ê
                            let perQuarter, total;
                            if (nums.length === 3) {
                                perQuarter = nums;
                                total = nums.reduce((sum, num) => sum + num, 0);
                            } else {
                                perQuarter = nums.slice(0, 3);
                                total = nums.slice(0, 3).reduce((sum, num) => sum + num, 0);
                            }
                            
                            scoreLines.push({
                                name: teamName,
                                perQuarter: perQuarter,
                                total: total,
                                raw: line
                            });
                        }
                    }
                    
                    if (scoreLines.length >= 2) break;
                }
                
                result.teams = scoreLines;
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
            if (result.teams.length < 2) {
                const allNumbers = [];
                for (const line of lines) {
                    const numbers = line.match(/\d+/g);
                    if (numbers && numbers.length >= 3) {
                        const nums = numbers.map(n => parseInt(n, 10));
                        if (nums.every(n => n >= 0 && n <= 200)) {
                            allNumbers.push(nums);
                        }
                    }
                }
                
                if (allNumbers.length >= 2) {
                    result.teams = [
                        { 
                            name: '–ö–æ–º–∞–Ω–¥–∞ 1', 
                            perQuarter: allNumbers[0].slice(0, 3), 
                            total: allNumbers[0].slice(0, 3).reduce((sum, num) => sum + num, 0)
                        },
                        { 
                            name: '–ö–æ–º–∞–Ω–¥–∞ 2', 
                            perQuarter: allNumbers[1].slice(0, 3), 
                            total: allNumbers[1].slice(0, 3).reduce((sum, num) => sum + num, 0)
                        }
                    ];
                }
            }

            return result;
        }

        function renderParsed(parsed) {
            parsedEl.innerHTML = '';

            const title = document.createElement('div');
            title.innerHTML = `<strong>–ú–∞—Ç—á:</strong> ${escapeHtml(parsed.title || '')}`;
            parsedEl.appendChild(title);

            if (parsed.timeBlock) {
                const tdiv = document.createElement('div');
                tdiv.innerHTML = `<strong>–í—Ä–µ–º—è/—á–µ—Ç–≤–µ—Ä—Ç—å:</strong> ${escapeHtml(parsed.timeBlock.raw)}`;
                parsedEl.appendChild(tdiv);
            }

            const formatDiv = document.createElement('div');
            const formatParts = parsed.format.split('x');
            const quarters = formatParts[0];
            const minutes = formatParts[1];
            formatDiv.innerHTML = `<strong>–§–æ—Ä–º–∞—Ç –∏–≥—Ä—ã:</strong> ${quarters} —á–µ—Ç–≤–µ—Ä—Ç–∏ –ø–æ ${minutes} –º–∏–Ω—É—Ç`;
            parsedEl.appendChild(formatDiv);

            if (parsed.teams && parsed.teams.length>0) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = `–£—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ ${parsed.teams.length} –∫–æ–º–∞–Ω–¥`;
                parsedEl.appendChild(successDiv);

                const t = document.createElement('div');
                t.innerHTML = '<strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong>';
                parsedEl.appendChild(t);

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                thead.innerHTML = '<tr><th>–ö–æ–º–∞–Ω–¥–∞</th><th>–ü–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º</th><th>–ò—Ç–æ–≥–æ</th></tr>';
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                for (const team of parsed.teams) {
                    const tr = document.createElement('tr');
                    const nameTd = document.createElement('td');
                    nameTd.textContent = team.name;
                    const pqTd = document.createElement('td');
                    pqTd.textContent = (team.perQuarter && team.perQuarter.length>0) ? team.perQuarter.join(' + ') : '-';
                    const totalTd = document.createElement('td');
                    totalTd.textContent = (team.total != null) ? team.total : '-';
                    tr.appendChild(nameTd); tr.appendChild(pqTd); tr.appendChild(totalTd);
                    tbody.appendChild(tr);
                }
                table.appendChild(tbody);
                parsedEl.appendChild(table);
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–∞–Ω–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
                parsedEl.appendChild(errorDiv);
            }

            // raw lines (for debugging)
            const rawBlock = document.createElement('details');
            rawBlock.style.marginTop = '8px';
            rawBlock.innerHTML = `<summary class="small">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)</summary>
                <div class="small" style="margin-top:4px">${escapeHtml(parsed.rawLines.join('\n'))}</div>`;
            parsedEl.appendChild(rawBlock);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function renderManualEdit(parsed) {
            manualEditEl.innerHTML = '';
            
            const editSection = document.createElement('div');
            editSection.className = 'edit-section';
            
            const title = document.createElement('div');
            title.className = 'section-title';
            title.textContent = '–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö';
            editSection.appendChild(title);
            
            // –§–æ—Ä–º–∞—Ç –∏–≥—Ä—ã
            const formatDiv = document.createElement('div');
            formatDiv.className = 'edit-format';
            formatDiv.innerHTML = `
                <label><strong>–§–æ—Ä–º–∞—Ç –∏–≥—Ä—ã:</strong></label>
                <input type="number" id="editQuarters" class="edit-input" min="1" max="10" value="${parsed.quarters || 4}"> —á–µ—Ç–≤–µ—Ä—Ç–∏ –ø–æ 
                <input type="number" id="editMinutes" class="edit-input" min="1" max="20" value="${parsed.minutesPerQuarter || 5}"> –º–∏–Ω—É—Ç
            `;
            editSection.appendChild(formatDiv);
            
            // –í—Ä–µ–º—è –º–∞—Ç—á–∞ - —Ç–µ–ø–µ—Ä—å –≤–≤–æ–¥–∏—Ç—Å—è —Å—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ —á–µ—Ç–≤–µ—Ä—Ç–∏
            const timeDiv = document.createElement('div');
            timeDiv.className = 'edit-time';
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Å—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
            let playedMinutes = 0;
            let playedSeconds = 0;
            
            if (parsed.timeBlock && parsed.timeBlock.timeRemaining) {
                const [min, sec] = parsed.timeBlock.timeRemaining.split(':').map(Number);
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –≤ —Å—ã–≥—Ä–∞–Ω–Ω–æ–µ
                playedMinutes = parsed.minutesPerQuarter - min - (sec > 0 ? 1 : 0);
                playedSeconds = sec > 0 ? 60 - sec : 0;
            }
            
            timeDiv.innerHTML = `
                <div><strong>–í—Ä–µ–º—è –º–∞—Ç—á–∞:</strong></div>
                <div style="margin-top: 8px;">
                    <label>–¢–µ–∫—É—â–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å:</label>
                    <select id="editCurrentQuarter" class="edit-input">
                        <option value="1" ${parsed.timeBlock && parsed.timeBlock.quarter === 1 ? 'selected' : ''}>1</option>
                        <option value="2" ${parsed.timeBlock && parsed.timeBlock.quarter === 2 ? 'selected' : ''}>2</option>
                        <option value="3" ${parsed.timeBlock && parsed.timeBlock.quarter === 3 ? 'selected' : ''}>3</option>
                        <option value="4" ${parsed.timeBlock && parsed.timeBlock.quarter === 4 ? 'selected' : ''}>4</option>
                    </select>
                </div>
                <div style="margin-top: 8px;">
                    <label>–°—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ —á–µ—Ç–≤–µ—Ä—Ç–∏:</label>
                    <input type="number" id="editPlayedMinutes" class="edit-input" min="0" max="59" value="${playedMinutes}"> –º–∏–Ω
                    <input type="number" id="editPlayedSeconds" class="edit-input" min="0" max="59" value="${playedSeconds}"> —Å–µ–∫
                </div>
                <div class="time-display">
                    <div class="time-row">
                        <span class="time-label">–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤ —á–µ—Ç–≤–µ—Ä—Ç–∏:</span>
                        <span class="time-value" id="remainingInQuarter">0 –º–∏–Ω 0 —Å–µ–∫</span>
                    </div>
                    <div class="time-row">
                        <span class="time-label">–°—ã–≥—Ä–∞–Ω–æ –≤—Å–µ–≥–æ:</span>
                        <span class="time-value" id="playedTotal">0 –º–∏–Ω 0 —Å–µ–∫</span>
                    </div>
                    <div class="time-row">
                        <span class="time-label">–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ:</span>
                        <span class="time-value" id="remainingTotal">0 –º–∏–Ω 0 —Å–µ–∫</span>
                    </div>
                </div>
            `;
            editSection.appendChild(timeDiv);
            
            // –ö–æ–º–∞–Ω–¥—ã
            const teamsDiv = document.createElement('div');
            teamsDiv.innerHTML = '<strong>–°—á–µ—Ç –∫–æ–º–∞–Ω–¥:</strong>';
            editSection.appendChild(teamsDiv);
            
            for (let i = 0; i < Math.max(2, parsed.teams.length); i++) {
                const team = parsed.teams[i] || { name: `–ö–æ–º–∞–Ω–¥–∞ ${i+1}`, perQuarter: [0, 0, 0], total: 0 };
                
                const teamDiv = document.createElement('div');
                teamDiv.className = 'edit-team';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'edit-team-name';
                nameDiv.innerHTML = `<label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã ${i+1}:</label>`;
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = team.name;
                nameInput.id = `teamName${i}`;
                nameInput.classList.add('edit-input');
                nameInput.style.width = '100%';
                nameDiv.appendChild(nameInput);
                teamDiv.appendChild(nameDiv);
                
                const scoresDiv = document.createElement('div');
                scoresDiv.className = 'edit-scores';
                scoresDiv.innerHTML = '<label>–û—á–∫–∏ –ø–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º:</label>';
                
                for (let q = 0; q < 3; q++) {
                    const scoreInput = document.createElement('input');
                    scoreInput.type = 'number';
                    scoreInput.min = '0';
                    scoreInput.max = '200';
                    scoreInput.classList.add('edit-input');
                    scoreInput.value = team.perQuarter && team.perQuarter[q] ? team.perQuarter[q] : 0;
                    scoreInput.id = `team${i}q${q}`;
                    scoresDiv.appendChild(scoreInput);
                    
                    if (q < 2) {
                        const plus = document.createElement('span');
                        plus.textContent = '+';
                        scoresDiv.appendChild(plus);
                    }
                }
                
                const totalSpan = document.createElement('span');
                totalSpan.id = `team${i}Total`;
                totalSpan.style.fontWeight = 'bold';
                totalSpan.style.marginLeft = '8px';
                totalSpan.textContent = `= ${team.total || 0}`;
                scoresDiv.appendChild(totalSpan);
                
                teamDiv.appendChild(scoresDiv);
                editSection.appendChild(teamDiv);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            const applyButton = document.createElement('button');
            applyButton.textContent = '–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
            applyButton.style.marginTop = '12px';
            applyButton.onclick = applyManualEdits;
            editSection.appendChild(applyButton);
            
            manualEditEl.appendChild(editSection);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—É–º–º—ã
            for (let i = 0; i < Math.max(2, parsed.teams.length); i++) {
                for (let q = 0; q < 3; q++) {
                    const input = document.getElementById(`team${i}q${q}`);
                    input.addEventListener('input', updateTeamTotal);
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('editCurrentQuarter').addEventListener('change', updateTimeCalculations);
            document.getElementById('editPlayedMinutes').addEventListener('input', updateTimeCalculations);
            document.getElementById('editPlayedSeconds').addEventListener('input', updateTimeCalculations);
            document.getElementById('editQuarters').addEventListener('input', updateTimeCalculations);
            document.getElementById('editMinutes').addEventListener('input', updateTimeCalculations);
            
            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
            updateTimeCalculations();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã –æ—á–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã
        function updateTeamTotal() {
            const teamIndex = this.id.match(/team(\d+)q/)[1];
            let total = 0;
            
            for (let q = 0; q < 3; q++) {
                const input = document.getElementById(`team${i}q${q}`);
                total += parseInt(input.value) || 0;
            }
            
            const totalSpan = document.getElementById(`team${teamIndex}Total`);
            totalSpan.textContent = `= ${total}`;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –º–∞—Ç—á–∞
        function updateTimeCalculations() {
            const quarters = parseInt(document.getElementById('editQuarters').value) || 4;
            const minutesPerQuarter = parseInt(document.getElementById('editMinutes').value) || 5;
            const currentQuarter = parseInt(document.getElementById('editCurrentQuarter').value) || 1;
            const playedMinutes = parseInt(document.getElementById('editPlayedMinutes').value) || 0;
            const playedSeconds = parseInt(document.getElementById('editPlayedSeconds').value) || 0;
            
            // –û–±—â–µ–µ –≤—Ä–µ–º—è –∏–≥—Ä—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            const totalGameSeconds = quarters * minutesPerQuarter * 60;
            
            // –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –≤ —Ç–µ–∫—É—â–µ–π —á–µ—Ç–≤–µ—Ä—Ç–∏
            const quarterTotalSeconds = minutesPerQuarter * 60;
            const playedInQuarterSeconds = playedMinutes * 60 + playedSeconds;
            const remainingInQuarterSeconds = quarterTotalSeconds - playedInQuarterSeconds;
            
            const remainingInQuarterMinutes = Math.floor(remainingInQuarterSeconds / 60);
            const remainingInQuarterSecs = remainingInQuarterSeconds % 60;
            
            // –û–±—â–µ–µ —Å—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            const playedQuarters = currentQuarter - 1;
            const playedTotalSeconds = playedQuarters * quarterTotalSeconds + playedInQuarterSeconds;
            
            const playedTotalMinutes = Math.floor(playedTotalSeconds / 60);
            const playedTotalSecs = playedTotalSeconds % 60;
            
            // –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –≤ –º–∞—Ç—á–µ
            const remainingTotalSeconds = totalGameSeconds - playedTotalSeconds;
            const remainingTotalMinutes = Math.floor(remainingTotalSeconds / 60);
            const remainingTotalSecs = remainingTotalSeconds % 60;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('remainingInQuarter').textContent = 
                `${remainingInQuarterMinutes} –º–∏–Ω ${remainingInQuarterSecs} —Å–µ–∫`;
            
            document.getElementById('playedTotal').textContent = 
                `${playedTotalMinutes} –º–∏–Ω ${playedTotalSecs} —Å–µ–∫`;
            
            document.getElementById('remainingTotal').textContent = 
                `${remainingTotalMinutes} –º–∏–Ω ${remainingTotalSecs} —Å–µ–∫`;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä—É—á–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function applyManualEdits() {
            if (!currentParsedData) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∏–≥—Ä—ã
            const quarters = parseInt(document.getElementById('editQuarters').value) || 4;
            const minutes = parseInt(document.getElementById('editMinutes').value) || 5;
            
            currentParsedData.quarters = quarters;
            currentParsedData.minutesPerQuarter = minutes;
            currentParsedData.format = `${quarters}x${minutes}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏
            const currentQuarter = parseInt(document.getElementById('editCurrentQuarter').value) || 1;
            const playedMinutes = parseInt(document.getElementById('editPlayedMinutes').value) || 0;
            const playedSeconds = parseInt(document.getElementById('editPlayedSeconds').value) || 0;
            
            currentParsedData.manualTime = {
                quarter: currentQuarter,
                playedMinutes: playedMinutes,
                playedSeconds: playedSeconds
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥
            for (let i = 0; i < 2; i++) {
                const nameInput = document.getElementById(`teamName${i}`);
                if (nameInput) {
                    if (!currentParsedData.teams[i]) {
                        currentParsedData.teams[i] = { name: '', perQuarter: [0, 0, 0], total: 0 };
                    }
                    currentParsedData.teams[i].name = nameInput.value;
                    
                    let total = 0;
                    const perQuarter = [];
                    for (let q = 0; q < 3; q++) {
                        const scoreInput = document.getElementById(`team${i}q${q}`);
                        const score = parseInt(scoreInput.value) || 0;
                        perQuarter.push(score);
                        total += score;
                    }
                    
                    currentParsedData.teams[i].perQuarter = perQuarter;
                    currentParsedData.teams[i].total = total;
                }
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
            renderParsed(currentParsedData);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ—Ç–∞–ª—ã
            calculateAndDisplayTotals(currentParsedData);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!';
            successMsg.style.marginTop = '8px';
            manualEditEl.appendChild(successMsg);
            
            // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ—Ç–∞–ª–æ–≤
        function calculateAndDisplayTotals(parsed) {
            calculationsEl.innerHTML = '';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
            if (!parsed.teams || parsed.teams.length < 2) {
                calculationsEl.innerHTML = '<div class="error">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ç–æ—Ç–∞–ª–æ–≤</div>';
                return;
            }
            
            const team1 = parsed.teams[0];
            const team2 = parsed.teams[1];
            const totalScore = (team1.total || 0) + (team2.total || 0);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã
            const quarterLength = parsed.minutesPerQuarter || 5;
            const totalQuarters = parsed.quarters || 4;
            const totalGameMinutes = quarterLength * totalQuarters;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            let minutesPlayed = 0;
            let minutesRemaining = totalGameMinutes;
            
            if (parsed.manualTime) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
                const currentQuarter = parsed.manualTime.quarter;
                const playedMinutes = parsed.manualTime.playedMinutes;
                const playedSeconds = parsed.manualTime.playedSeconds;
                
                // –°—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è = –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —á–µ—Ç–≤–µ—Ä—Ç–∏ + —Å—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤ —Ç–µ–∫—É—â–µ–π —á–µ—Ç–≤–µ—Ä—Ç–∏
                const completedQuarters = currentQuarter - 1;
                minutesPlayed = completedQuarters * quarterLength + playedMinutes + playedSeconds/60;
                minutesRemaining = totalGameMinutes - minutesPlayed;
            } else if (parsed.timeBlock && parsed.timeBlock.quarter) {
                const currentQuarter = parsed.timeBlock.quarter;
                
                // –í—Ä–µ–º—è –≤ —Ç–µ–∫—É—â–µ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ (–æ—Å—Ç–∞–≤—à–µ–µ—Å—è)
                let quarterMinutesRemaining = 0;
                if (parsed.timeBlock.timeRemaining) {
                    const [min, sec] = parsed.timeBlock.timeRemaining.split(':').map(Number);
                    quarterMinutesRemaining = min + sec/60;
                }
                
                // –°—ã–≥—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è = –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —á–µ—Ç–≤–µ—Ä—Ç–∏ + (–¥–ª–∏–Ω–∞ —á–µ—Ç–≤–µ—Ä—Ç–∏ - –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è)
                const completedQuarters = currentQuarter - 1;
                minutesPlayed = completedQuarters * quarterLength + (quarterLength - quarterMinutesRemaining);
                minutesRemaining = totalGameMinutes - minutesPlayed;
            } else {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–µ—Ç–≤–µ—Ä—Ç–∏ –∏–∑ —Å—á–µ—Ç–∞
                const maxQuarters = Math.max(
                    team1.perQuarter ? team1.perQuarter.length : 0,
                    team2.perQuarter ? team2.perQuarter.length : 0
                );
                minutesPlayed = maxQuarters * quarterLength;
                minutesRemaining = totalGameMinutes - minutesPlayed;
            }
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–º–ø –∏–≥—Ä—ã
            const tempo = minutesPlayed > 0 ? totalScore / minutesPlayed : 2.0;
            
            // –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º —Ç–æ—Ç–∞–ª—ã
            const projectedRemainingPoints = Math.round(tempo * minutesRemaining);
            const projectedTotal = totalScore + projectedRemainingPoints;
            const projectedNextQuarter = Math.round(tempo * quarterLength);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const statsHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalScore}</div>
                        <div class="stat-label">–¢–µ–∫—É—â–∏–π –æ–±—â–∏–π —Å—á–µ—Ç</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${minutesPlayed.toFixed(1)}</div>
                        <div class="stat-label">–°—ã–≥—Ä–∞–Ω–æ –º–∏–Ω—É—Ç</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${minutesRemaining.toFixed(1)}</div>
                        <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å –º–∏–Ω—É—Ç</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${tempo.toFixed(2)}</div>
                        <div class="stat-label">–¢–µ–º–ø (–æ—á–∫–æ–≤/–º–∏–Ω—É—Ç—É)</div>
                    </div>
                </div>
            `;
            
            calculationsEl.innerHTML = statsHTML;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑—ã
            const predictionsHTML = `
                <div class="prediction">
                    <div class="prediction-title">–ü—Ä–æ–≥–Ω–æ–∑ –æ–±—â–µ–≥–æ —Ç–æ—Ç–∞–ª–∞ –º–∞—Ç—á–∞</div>
                    <div class="prediction-value">${projectedTotal}</div>
                    <div class="small">–¢–µ–∫—É—â–∏–π —Å—á–µ—Ç (${totalScore}) + –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è (${projectedRemainingPoints})</div>
                </div>
                
                <div class="prediction">
                    <div class="prediction-title">–ü—Ä–æ–≥–Ω–æ–∑ —Ç–æ—Ç–∞–ª–∞ —Å–ª–µ–¥—É—é—â–µ–π —á–µ—Ç–≤–µ—Ä—Ç–∏</div>
                    <div class="prediction-value">${projectedNextQuarter}</div>
                    <div class="small">–¢–µ–º–ø (${tempo.toFixed(2)}) √ó –¥–ª–∏–Ω–∞ —á–µ—Ç–≤–µ—Ä—Ç–∏ (${quarterLength} –º–∏–Ω)</div>
                </div>
            `;
            
            calculationsEl.innerHTML += predictionsHTML;
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }
    </script>
</body>
</html>
