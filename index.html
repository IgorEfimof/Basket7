<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon202.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSK7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Парсер NBA 2K + Калькулятор</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #222;
            --primary: #3182ce;
            --border-color: #ddd;
            --success-bg: #c6f6d5;
            --success-color: #22543d;
            --error-bg: #fed7d7;
            --error-color: #c53030;
        }
        [data-theme="dark"] {
            --bg-color: #2d3748;
            --container-bg: #4a5568;
            --text-color: #f7fafc;
            --primary: #63b3ed;
            --border-color: #718096;
            --success-bg: #22543d;
            --success-color: #c6f6d5;
            --error-bg: #c53030;
            --error-color: #fed7d7;
        }
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            padding: 8px;
            color: var(--text-color);
            background: var(--bg-color);
            line-height: 1.2;
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
        }
        .container {
            background: var(--container-bg);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        h1 {
            font-size: 16px;
            margin: 0;
            color: var(--primary);
        }
        .header-controls {
            display: flex;
            gap: 6px;
        }
        .theme-toggle, .clear-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-color);
            padding: 4px;
            border-radius: 4px;
            background: rgba(0,0,0,0.05);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .section {
            margin: 12px 0;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }
        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 6px;
            color: var(--primary);
        }
        .controls {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        input[type=file] {
            cursor: pointer;
            flex: 1;
            min-width: 0;
            font-size: 12px;
        }
        button {
            padding: 6px 8px;
            border: 0;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            flex-shrink: 0;
            font-size: 12px;
        }
        button:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
        #preview {
            width: 100%;
            max-height: 180px;
            min-height: 120px;
            border: 1px solid var(--border-color);
            margin: 6px 0;
            display: block;
            border-radius: 4px;
            object-fit: contain;
            background-color: rgba(0,0,0,0.02);
        }
        .log {
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            padding: 6px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 11px;
            max-height: 80px;
            overflow-y: auto;
            margin: 6px 0;
        }
        .compact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 8px 0;
        }
        .compact-card {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            padding: 6px;
            border-left: 2px solid var(--primary);
            font-size: 12px;
        }
        .compact-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary);
        }
        .compact-label {
            font-size: 10px;
            opacity: 0.8;
        }
        .teams-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 8px 0;
        }
        .team-card {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            padding: 6px;
            font-size: 12px;
        }
        .team-name {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 12px;
        }
        .team-scores {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }
        .score-input {
            width: 25px;
            height: 25px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--container-bg);
            color: var(--text-color);
            font-size: 11px;
        }
        .total-score {
            font-weight: bold;
            font-size: 13px;
            color: var(--primary);
        }
        .edit-controls-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }
        .time-controls {
            display: flex;
            gap: 4px;
            align-items: center;
            font-size: 11px;
            margin-bottom: 6px;
        }
        .time-input {
            width: 30px;
            height: 25px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--container-bg);
            color: var(--text-color);
            font-size: 11px;
        }
        .calc-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        .prediction-compact {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            padding: 6px;
            border-left: 2px solid var(--primary);
        }
        .prediction-title {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .prediction-value {
            font-size: 16px;
            font-weight: bold;
        }
        .error {
            background: var(--error-bg);
            color: var(--error-color);
            padding: 6px;
            border-radius: 4px;
            margin: 6px 0;
            font-size: 11px;
        }
        .success {
            background: var(--success-bg);
            color: var(--success-color);
            padding: 6px;
            border-radius: 4px;
            margin: 6px 0;
            font-size: 11px;
        }
        .keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--container-bg);
            border-top: 1px solid var(--border-color);
            padding: 4px;
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            z-index: 1000;
            height: 140px;
            transform: translateZ(0);
        }
        .keyboard button {
            padding: 6px 2px;
            font-size: 14px;
            background: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            min-height: 32px;
        }
        .keyboard-close {
            grid-column: span 4;
            margin-top: 4px;
            background: var(--primary) !important;
            color: white !important;
        }
        .small-text {
            font-size: 10px;
            opacity: 0.7;
        }
        @media (max-width: 480px) {
            body {
                padding: 6px;
            }
            .container {
                padding: 8px;
                height: calc(100vh - 12px);
            }
            h1 {
                font-size: 14px;
            }
            .section {
                margin: 8px 0;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            button {
                width: 100%;
                padding: 8px;
            }
            #preview {
                max-height: 160px;
                min-height: 100px;
            }
            .keyboard {
                height: 120px;
            }
            .keyboard button {
                min-height: 28px;
                font-size: 12px;
            }
        }

        /* Стили для лучшего отображения скриншота */
        .preview-container {
            position: relative;
            margin: 6px 0;
        }
        .preview-help {
            font-size: 10px;
            color: var(--text-color);
            opacity: 0.7;
            text-align: center;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Парсер NBA 2K</h1>
            <div class="header-controls">
                <button class="clear-btn" id="clearBtn" title="Очистить все">✕</button>
                <button class="theme-toggle" id="themeToggle" title="Сменить тему">🌙</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="section">
                <div class="section-title">Загрузка скриншота</div>
                <div class="controls">
                    <input id="file" type="file" accept="image/*">
                    <button id="run" disabled>Распознать</button>
                </div>
                <div class="preview-container">
                    <img id="preview" alt="preview">
                </div>
                <div class="preview-help">Убедитесь, что на скриншоте виден общий счет и очки команд по четвертям</div>
                <div id="status" class="small-text">Выберите изображение</div>
            </div>

            <div class="section">
                <div class="section-title">Результаты парсинга</div>
                <div id="parsed"></div>
            </div>

            <div class="section">
                <div class="section-title">Корректировка данных</div>
                <div id="manualEdit"></div>
            </div>

            <div class="section">
                <div class="section-title">Расчет тоталов</div>
                <div id="calculations"></div>
            </div>
        </div>
    </div>

    <div class="keyboard" id="keyboard">
        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button data-value="backspace">⌫</button>
        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button data-value="0">0</button>
        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button data-value=":">:</button>
        <button data-value=".">.</button>
        <button data-value="-">-</button>
        <button class="keyboard-close" id="keyboardClose">Готово</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        // Инициализация переменных
        const fileInput = document.getElementById('file');
        const preview = document.getElementById('preview');
        const runBtn = document.getElementById('run');
        const status = document.getElementById('status');
        const parsedEl = document.getElementById('parsed');
        const manualEditEl = document.getElementById('manualEdit');
        const calculationsEl = document.getElementById('calculations');
        const themeToggle = document.getElementById('themeToggle');
        const clearBtn = document.getElementById('clearBtn');
        const keyboard = document.getElementById('keyboard');
        const keyboardClose = document.getElementById('keyboardClose');
        
        let currentImage = null;
        let currentParsedData = null;
        let activeInput = null;

        // Очистка всех данных
        clearBtn.addEventListener('click', () => {
            fileInput.value = '';
            preview.src = '';
            currentImage = null;
            runBtn.disabled = true;
            status.textContent = 'Выберите изображение';
            parsedEl.innerHTML = '';
            manualEditEl.innerHTML = '';
            calculationsEl.innerHTML = '';
            keyboard.style.display = 'none';
            activeInput = null;
        });

        // Переключение темы
        themeToggle.addEventListener('click', () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? '' : 'dark');
            themeToggle.textContent = isDark ? '🌙' : '☀️';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        });

        // Загрузка темы из localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            themeToggle.textContent = '☀️';
        }

        // Обработчики для кастомной клавиатуры
        document.querySelectorAll('.keyboard button[data-value]').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!activeInput) return;
                
                const value = e.target.getAttribute('data-value');
                if (value === 'backspace') {
                    activeInput.value = activeInput.value.slice(0, -1);
                } else {
                    activeInput.value += value;
                }
                
                activeInput.dispatchEvent(new Event('input', { bubbles: true }));
            });
        });

        keyboardClose.addEventListener('click', () => {
            keyboard.style.display = 'none';
            activeInput = null;
        });

        // Скрытие клавиатуры при клике вне полей ввода
        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('score-input') && 
                !e.target.classList.contains('time-input') &&
                !keyboard.contains(e.target)) {
                keyboard.style.display = 'none';
                activeInput = null;
            }
        });

        // Показ кастомной клавиатуры
        document.addEventListener('focusin', (e) => {
            if (e.target.classList.contains('score-input') || 
                e.target.classList.contains('time-input')) {
                e.preventDefault();
                activeInput = e.target;
                keyboard.style.display = 'grid';
                
                activeInput.setAttribute('readonly', 'true');
                activeInput.blur();
            }
        });

        // Обработчик загрузки файла
        fileInput.addEventListener('change', e => {
            const f = e.target.files[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            preview.src = url;
            currentImage = f;
            runBtn.disabled = false;
            status.textContent = 'Готово. Нажми "Распознать"';
            parsedEl.innerHTML = '';
            manualEditEl.innerHTML = '';
            calculationsEl.innerHTML = '';
            
            // Автоматическое масштабирование изображения для лучшего отображения
            preview.onload = function() {
                // Установка оптимальной высоты в зависимости от пропорций изображения
                const aspectRatio = preview.naturalWidth / preview.naturalHeight;
                if (aspectRatio > 1.5) {
                    // Широкое изображение - уменьшаем высоту
                    preview.style.maxHeight = '140px';
                } else {
                    // Высокое изображение - увеличиваем высоту
                    preview.style.maxHeight = '180px';
                }
            };
        });

        // Обработчик кнопки распознавания
        runBtn.addEventListener('click', async () => {
            if (!currentImage) return;
            runBtn.disabled = true;
            status.textContent = 'Инициализация OCR...';

            try {
                status.textContent = 'Распознаю изображение...';
                
                const { data: { text } } = await Tesseract.recognize(
                    currentImage,
                    'rus+eng',
                    { 
                        logger: m => {
                            if (m.status) status.textContent = m.status;
                        }
                    }
                );
                
                status.textContent = 'Парсинг распознанного текста...';

                const parsed = parseMatchText(text);
                currentParsedData = parsed;
                renderParsed(parsed);
                renderManualEdit(parsed);
                
                calculateAndDisplayTotals(parsed);

                status.textContent = 'Готово';
            } catch (err) {
                console.error(err);
                status.textContent = 'Ошибка: ' + (err.message || err);
            } finally {
                runBtn.disabled = false;
            }
        });

        // Функция-парсер
        function parseMatchText(text) {
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length>0);
            const result = { 
                rawLines: lines, 
                title: null, 
                timeBlock: null, 
                teams: [],
                format: '4x10',
                quarters: 4,
                minutesPerQuarter: 10
            };

            // Поиск заголовка матча
            for (const l of lines) {
                if (/Баскетбол|NBA|IPBL|Pro Division/i.test(l)) {
                    result.title = l;
                    if (result.title.includes('3x3')) {
                        result.title = result.title.replace('3x3', '5x5');
                    }
                    break;
                }
            }
            if (!result.title) result.title = lines[0] || '';

            // Поиск времени и четверти
            for (const l of lines) {
                const timeMatch = l.match(/(\d{1,2}:\d{2})\s*[|]\s*(\d+)-я\s*четверть\s*,\s*(\d{1,2}:\d{2})/i);
                if (timeMatch) {
                    result.timeBlock = {
                        clock: timeMatch[1],
                        quarter: parseInt(timeMatch[2]),
                        timeRemaining: timeMatch[3],
                        raw: l
                    };
                    break;
                }
                
                const altMatch = l.match(/(\d+)-я\s*четверть.*?(\d{1,2}:\d{2})/i);
                if (altMatch && !result.timeBlock) {
                    result.timeBlock = {
                        clock: '00:00',
                        quarter: parseInt(altMatch[1]),
                        timeRemaining: altMatch[2],
                        raw: l
                    };
                }
            }

            // Поиск команд и счета
            const teams = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.match(/[А-Яа-я]+\s*Pro/) || line.match(/[А-Яа-я]+\s*\(ж\)/)) {
                    const numbers = line.match(/\d+/g);
                    if (numbers && numbers.length >= 2) {
                        const teamName = line.split(/\d/)[0].trim();
                        const score1 = parseInt(numbers[0]);
                        
                        teams.push({
                            name: teamName,
                            perQuarter: [score1],
                            total: score1,
                            raw: line
                        });
                    }
                }
            }
            
            if (teams.length >= 2) {
                result.teams = teams;
            } else {
                const scorePattern = /\b(\d+)\s+(\d+)\b/;
                for (let i = 0; i < lines.length; i++) {
                    const match = lines[i].match(scorePattern);
                    if (match) {
                        const score1 = parseInt(match[1]);
                        
                        let teamName = `Команда ${teams.length + 1}`;
                        for (let j = Math.max(0, i-2); j < i; j++) {
                            if (lines[j] && !lines[j].match(/\d/) && lines[j].length > 3) {
                                teamName = lines[j];
                                break;
                            }
                        }
                        
                        teams.push({
                            name: teamName,
                            perQuarter: [score1],
                            total: score1,
                            raw: lines[i]
                        });
                        
                        if (teams.length >= 2) break;
                    }
                }
                result.teams = teams;
            }

            // Добавляем нули для недостающих квартеров
            if (result.teams.length > 0) {
                result.teams.forEach(team => {
                    if (team.perQuarter.length < 4) {
                        while (team.perQuarter.length < 4) {
                            team.perQuarter.push(0);
                        }
                    }
                });
            }

            return result;
        }

        function renderParsed(parsed) {
            parsedEl.innerHTML = '';

            if (parsed.teams && parsed.teams.length>0) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = `Распознано ${parsed.teams.length} команд`;
                parsedEl.appendChild(successDiv);

                // Компактное отображение команд
                const teamsGrid = document.createElement('div');
                teamsGrid.className = 'teams-row';
                
                parsed.teams.forEach((team, index) => {
                    const teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'team-name';
                    nameDiv.textContent = team.name;
                    teamCard.appendChild(nameDiv);
                    
                    const scoresDiv = document.createElement('div');
                    scoresDiv.className = 'team-scores';
                    
                    if (team.perQuarter && team.perQuarter.length>0) {
                        scoresDiv.textContent = team.perQuarter.join(' + ');
                    }
                    teamCard.appendChild(scoresDiv);
                    
                    const totalDiv = document.createElement('div');
                    totalDiv.className = 'total-score';
                    totalDiv.textContent = `Итого: ${team.total || 0}`;
                    teamCard.appendChild(totalDiv);
                    
                    teamsGrid.appendChild(teamCard);
                });
                
                parsedEl.appendChild(teamsGrid);
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Не удалось найти результаты команд';
                parsedEl.appendChild(errorDiv);
            }
        }

        // Функция отображения формы для ручного редактирования
        function renderManualEdit(parsed) {
            manualEditEl.innerHTML = '';
            
            const editSection = document.createElement('div');
            
            // Двухколоночный layout для формата и времени
            const topControls = document.createElement('div');
            topControls.className = 'edit-controls-compact';
            
            // Левая колонка: формат игры
            const formatDiv = document.createElement('div');
            formatDiv.className = 'compact-card';
            formatDiv.innerHTML = `
                <div class="compact-label">Формат игры</div>
                <div class="time-controls">
                    <input type="number" id="editQuarters" class="time-input" min="1" max="10" value="${parsed.quarters || 4}"> x 
                    <input type="number" id="editMinutes" class="time-input" min="1" max="20" value="${parsed.minutesPerQuarter || 10}">
                </div>
            `;
            topControls.appendChild(formatDiv);
            
            // Правая колонка: текущая четверть и время
            const timeDiv = document.createElement('div');
            timeDiv.className = 'compact-card';
            
            // Вычисляем сыгранное время
            let playedMinutes = 0;
            let playedSeconds = 0;
            
            if (parsed.timeBlock && parsed.timeBlock.timeRemaining) {
                const [min, sec] = parsed.timeBlock.timeRemaining.split(':').map(Number);
                playedMinutes = parsed.minutesPerQuarter - min - (sec > 0 ? 1 : 0);
                playedSeconds = sec > 0 ? 60 - sec : 0;
            }
            
            timeDiv.innerHTML = `
                <div class="compact-label">Текущая четверть</div>
                <select id="editCurrentQuarter" class="time-input" style="width: 100%; margin-bottom: 4px;">
                    <option value="1" ${parsed.timeBlock && parsed.timeBlock.quarter === 1 ? 'selected' : ''}>1</option>
                    <option value="2" ${parsed.timeBlock && parsed.timeBlock.quarter === 2 ? 'selected' : ''}>2</option>
                    <option value="3" ${parsed.timeBlock && parsed.timeBlock.quarter === 3 ? 'selected' : ''}>3</option>
                    <option value="4" ${parsed.timeBlock && parsed.timeBlock.quarter === 4 ? 'selected' : ''}>4</option>
                </select>
                <div class="compact-label">Сыграно в четверти</div>
                <div class="time-controls">
                    <input type="number" id="editPlayedMinutes" class="time-input" min="0" max="59" value="${playedMinutes}">:
                    <input type="number" id="editPlayedSeconds" class="time-input" min="0" max="59" value="${playedSeconds}">
                </div>
            `;
            topControls.appendChild(timeDiv);
            
            editSection.appendChild(topControls);
            
            // Команды в две колонки
            const teamsRow = document.createElement('div');
            teamsRow.className = 'teams-row';
            
            for (let i = 0; i < Math.max(2, parsed.teams.length); i++) {
                const team = parsed.teams[i] || { name: `Команда ${i+1}`, perQuarter: [0, 0, 0, 0], total: 0 };
                
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-card';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = team.name;
                nameInput.id = `teamName${i}`;
                nameInput.classList.add('team-name');
                nameInput.style.width = '100%';
                nameInput.style.background = 'transparent';
                nameInput.style.border = 'none';
                nameInput.style.fontWeight = 'bold';
                nameInput.style.fontSize = '12px';
                nameInput.style.marginBottom = '4px';
                teamDiv.appendChild(nameInput);
                
                const scoresDiv = document.createElement('div');
                scoresDiv.className = 'team-scores';
                
                let total = 0;
                for (let q = 0; q < 4; q++) {
                    const scoreInput = document.createElement('input');
                    scoreInput.type = 'number';
                    scoreInput.min = '0';
                    scoreInput.max = '200';
                    scoreInput.classList.add('score-input');
                    scoreInput.value = team.perQuarter && team.perQuarter[q] ? team.perQuarter[q] : 0;
                    scoreInput.id = `team${i}q${q}`;
                    
                    scoreInput.addEventListener('input', function() {
                        updateTeamTotal(i);
                    });
                    
                    scoresDiv.appendChild(scoreInput);
                    total += parseInt(scoreInput.value) || 0;
                }
                
                teamDiv.appendChild(scoresDiv);
                
                const totalDiv = document.createElement('div');
                totalDiv.className = 'total-score';
                totalDiv.id = `team${i}Total`;
                totalDiv.textContent = `= ${total}`;
                teamDiv.appendChild(totalDiv);
                
                teamsRow.appendChild(teamDiv);
            }
            
            editSection.appendChild(teamsRow);
            
            // Кнопка применения
            const applyButton = document.createElement('button');
            applyButton.textContent = 'Применить изменения';
            applyButton.style.marginTop = '8px';
            applyButton.style.width = '100%';
            applyButton.onclick = applyManualEdits;
            editSection.appendChild(applyButton);
            
            manualEditEl.appendChild(editSection);
            
            // Обработчики для времени
            document.getElementById('editCurrentQuarter').addEventListener('change', updateTimeCalculations);
            document.getElementById('editPlayedMinutes').addEventListener('input', updateTimeCalculations);
            document.getElementById('editPlayedSeconds').addEventListener('input', updateTimeCalculations);
            document.getElementById('editQuarters').addEventListener('input', updateTimeCalculations);
            document.getElementById('editMinutes').addEventListener('input', updateTimeCalculations);
        }

        // Функция обновления общей суммы очков команды
        function updateTeamTotal(teamIndex) {
            let total = 0;
            
            for (let q = 0; q < 4; q++) {
                const input = document.getElementById(`team${teamIndex}q${q}`);
                if (input) {
                    total += parseInt(input.value) || 0;
                }
            }
            
            const totalDiv = document.getElementById(`team${teamIndex}Total`);
            if (totalDiv) {
                totalDiv.textContent = `= ${total}`;
            }
        }

        // Функция расчета времени матча
        function updateTimeCalculations() {
            // Эта функция теперь вызывается при применении изменений
        }

        // Функция применения ручных изменений
        function applyManualEdits() {
            if (!currentParsedData) return;
            
            // Обновляем формат игры
            const quarters = parseInt(document.getElementById('editQuarters').value) || 4;
            const minutes = parseInt(document.getElementById('editMinutes').value) || 10;
            
            currentParsedData.quarters = quarters;
            currentParsedData.minutesPerQuarter = minutes;
            currentParsedData.format = `${quarters}x${minutes}`;
            
            // Обновляем данные времени
            const currentQuarter = parseInt(document.getElementById('editCurrentQuarter').value) || 1;
            const playedMinutes = parseInt(document.getElementById('editPlayedMinutes').value) || 0;
            const playedSeconds = parseInt(document.getElementById('editPlayedSeconds').value) || 0;
            
            currentParsedData.manualTime = {
                quarter: currentQuarter,
                playedMinutes: playedMinutes,
                playedSeconds: playedSeconds
            };
            
            // Обновляем данные команд
            for (let i = 0; i < 2; i++) {
                const nameInput = document.getElementById(`teamName${i}`);
                if (nameInput) {
                    if (!currentParsedData.teams[i]) {
                        currentParsedData.teams[i] = { name: '', perQuarter: [0, 0, 0, 0], total: 0 };
                    }
                    currentParsedData.teams[i].name = nameInput.value;
                    
                    let total = 0;
                    const perQuarter = [];
                    for (let q = 0; q < 4; q++) {
                        const scoreInput = document.getElementById(`team${i}q${q}`);
                        if (scoreInput) {
                            const score = parseInt(scoreInput.value) || 0;
                            perQuarter.push(score);
                            total += score;
                        }
                    }
                    
                    currentParsedData.teams[i].perQuarter = perQuarter;
                    currentParsedData.teams[i].total = total;
                }
            }
            
            // Перерисовываем результаты парсинга
            renderParsed(currentParsedData);
            
            // Пересчитываем тоталы
            calculateAndDisplayTotals(currentParsedData);
            
            // Показываем сообщение об успехе
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.textContent = 'Изменения применены!';
            successMsg.style.marginTop = '6px';
            manualEditEl.appendChild(successMsg);
            
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 2000);
        }

        // Функция расчета и отображения тоталов
        function calculateAndDisplayTotals(parsed) {
            calculationsEl.innerHTML = '';
            
            if (!parsed.teams || parsed.teams.length < 2) {
                calculationsEl.innerHTML = '<div class="error">Недостаточно данных для расчета</div>';
                return;
            }
            
            const team1 = parsed.teams[0];
            const team2 = parsed.teams[1];
            const totalScore = (team1.total || 0) + (team2.total || 0);
            
            const quarterLength = parsed.minutesPerQuarter || 10;
            const totalQuarters = parsed.quarters || 4;
            const totalGameMinutes = quarterLength * totalQuarters;
            
            // Рассчитываем сыгранное время
            let minutesPlayed = 0;
            
            if (parsed.manualTime) {
                const currentQuarter = parsed.manualTime.quarter;
                const playedMinutes = parsed.manualTime.playedMinutes;
                const playedSeconds = parsed.manualTime.playedSeconds;
                
                minutesPlayed = (currentQuarter - 1) * quarterLength + playedMinutes + playedSeconds/60;
            } else if (parsed.timeBlock && parsed.timeBlock.quarter) {
                const currentQuarter = parsed.timeBlock.quarter;
                let quarterMinutesRemaining = 0;
                
                if (parsed.timeBlock.timeRemaining) {
                    const [min, sec] = parsed.timeBlock.timeRemaining.split(':').map(Number);
                    quarterMinutesRemaining = min + sec/60;
                }
                
                minutesPlayed = (currentQuarter - 1) * quarterLength + (quarterLength - quarterMinutesRemaining);
            } else {
                const playedQuarters = Math.max(
                    team1.perQuarter ? team1.perQuarter.filter(q => q > 0).length : 0,
                    team2.perQuarter ? team2.perQuarter.filter(q => q > 0).length : 0
                );
                minutesPlayed = playedQuarters * quarterLength;
            }
            
            const minutesRemaining = totalGameMinutes - minutesPlayed;
            const tempo = minutesPlayed > 0 ? totalScore / minutesPlayed : 2.0;
            
            // Прогнозируем тоталы
            const projectedRemainingPoints = Math.round(tempo * minutesRemaining);
            const projectedTotal = totalScore + projectedRemainingPoints;
            const projectedNextQuarter = Math.round(tempo * quarterLength);
            
            // Двухколоночное отображение результатов
            const resultsGrid = document.createElement('div');
            resultsGrid.className = 'calc-results';
            
            // Первая строка: текущий счет и сыграно минут
            const scoreCard = document.createElement('div');
            scoreCard.className = 'compact-card';
            scoreCard.innerHTML = `
                <div class="compact-label">Текущий общий счет</div>
                <div class="compact-value">${totalScore}</div>
            `;
            resultsGrid.appendChild(scoreCard);
            
            const playedCard = document.createElement('div');
            playedCard.className = 'compact-card';
            playedCard.innerHTML = `
                <div class="compact-label">Сыграно минут</div>
                <div class="compact-value">${minutesPlayed.toFixed(1)}</div>
            `;
            resultsGrid.appendChild(playedCard);
            
            // Вторая строка: осталось минут и темп
            const remainingCard = document.createElement('div');
            remainingCard.className = 'compact-card';
            remainingCard.innerHTML = `
                <div class="compact-label">Осталось минут</div>
                <div class="compact-value">${minutesRemaining.toFixed(1)}</div>
            `;
            resultsGrid.appendChild(remainingCard);
            
            const tempoCard = document.createElement('div');
            tempoCard.className = 'compact-card';
            tempoCard.innerHTML = `
                <div class="compact-label">Темп (очков/минуту)</div>
                <div class="compact-value">${tempo.toFixed(2)}</div>
            `;
            resultsGrid.appendChild(tempoCard);
            
            calculationsEl.appendChild(resultsGrid);
            
            // Прогнозы в две колонки
            const predictionsRow = document.createElement('div');
            predictionsRow.className = 'teams-row';
            
            const totalPrediction = document.createElement('div');
            totalPrediction.className = 'prediction-compact';
            totalPrediction.innerHTML = `
                <div class="prediction-title">Прогноз общего тотала</div>
                <div class="prediction-value">${projectedTotal}</div>
            `;
            predictionsRow.appendChild(totalPrediction);
            
            const quarterPrediction = document.createElement('div');
            quarterPrediction.className = 'prediction-compact';
            quarterPrediction.innerHTML = `
                <div class="prediction-title">Прогноз след. четверти</div>
                <div class="prediction-value">${projectedNextQuarter}</div>
            `;
            predictionsRow.appendChild(quarterPrediction);
            
            calculationsEl.appendChild(predictionsRow);
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }
    </script>
</body>
</html>
