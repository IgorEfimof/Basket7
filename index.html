<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon202.png">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BSK7">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Quick Totals — калькулятор тотала по темпу</title>
<style>
  :root{
    --bg: #0f1720; --card: #111318; --muted: #9aa6b2; --accent: #18a0ff; --good: #16a34a; --bad: #dc2626;
    --glass: rgba(255,255,255,0.03); --text-color: #e6eef6;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  .light-theme{
    --bg: #f5f5f5; --card: #ffffff; --muted: #6b7280; --accent: #3b82f6; --good: #10b981; --bad: #ef4444;
    --glass: rgba(0,0,0,0.03); --text-color: #1f2937;
  }
  html,body{
    height:100%; margin:0; 
    background: var(--bg); 
    color: var(--text-color); 
    transition: background 0.3s, color 0.3s;
    -webkit-text-size-adjust: 100%;
  }
  .wrap{max-width:100%; margin:0 auto; padding:12px; box-sizing:border-box;}
  header{display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap;}
  header h1{font-size:18px;margin:0; color:var(--accent); flex:1;}
  header p{margin:0; color:var(--muted); font-size:12px; width:100%;}
  .theme-toggle{background:var(--accent); color:white; border:none; border-radius:20px; padding:6px 12px; font-size:12px; cursor:pointer;}
  .card{background:var(--card); border-radius:10px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:10px;}
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:4px;}
  .row{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;}
  .col{flex:1 1 calc(50% - 6px); min-width:0; box-sizing:border-box;}
  .full-width{flex:1 1 100%;}
  input[type="number"], input[type="text"], select{
    width:100%; padding:10px; border-radius:6px; border:1px solid rgba(0,0,0,0.1); 
    background:var(--glass); color:inherit; font-size:16px; box-sizing:border-box;
    -webkit-appearance: none; appearance: none;
    -webkit-tap-highlight-color: transparent;
  }
  .small{font-size:11px; color:var(--muted); margin-top:4px;}
  .result{background:var(--glass); border-radius:8px; padding:10px; margin-top:8px;}
  .big{font-weight:700; font-size:18px; color:var(--accent);}
  .muted{color:var(--muted); font-size:12px;}
  .grid{display:grid; grid-template-columns:1fr; gap:8px;}
  .btn{
    padding:12px; 
    border-radius:6px; 
    background:var(--accent); 
    color:white; 
    border:none; 
    font-weight:600; 
    cursor:pointer; 
    width:100%; 
    margin-bottom:6px;
    -webkit-tap-highlight-color: rgba(0,0,0,0.1); 
    min-height: 44px;
  }
  .btn.secondary{background:transparent; border:1px solid var(--muted); color:var(--muted);}
  .scenario{padding:8px; border-radius:6px; background:var(--glass);}
  .positive{color:var(--good); font-weight:700;}
  .negative{color:var(--bad); font-weight:700;}
  footer{margin-top:6px; color:var(--muted); font-size:11px; text-align:center;}
  .inline{display:flex; gap:6px; align-items:center;}
  input[type="range"]{
    width:100%;
    -webkit-appearance: none;
    height: 6px;
    border-radius: 3px;
    background: var(--glass);
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }
  .keyboard{display:grid; grid-template-columns:repeat(4, 1fr); gap:6px; margin-top:10px;}
  .keyboard button{
    height:44px; 
    border-radius:6px; 
    border:1px solid rgba(0,0,0,0.1); 
    background:var(--card); 
    font-size:18px; 
    cursor:pointer;
    min-height: 44px; 
  }
  .keyboard button:active{background:var(--accent); color:white;}
  .keyboard-container{display:none; position:fixed; bottom:0; left:0; right:0; background:var(--card); padding:10px; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:100;}
  
  @media (max-width: 520px) {
    .wrap { padding: 10px; }
    .card { padding: 10px; }
    input[type="number"], input[type="text"], select {
      padding: 12px; 
      font-size: 16px; 
    }
    .btn { padding: 14px; }
    select {
      background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 10px;
      padding-right: 30px;
    }
  }
  
  @media (min-width:520px){
    .wrap{max-width:500px; padding:15px;}
    .grid{grid-template-columns:1fr 1fr;}
    .keyboard{display:none;}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Калькулятор тотала по темпу</h1>
    <button class="theme-toggle" id="themeToggle">Светлая тема</button>
    <p>Быстрый прикид для лайв-решения: сравни свой прогноз с линией букмекера.</p>
  </header>

  <div class="card">
    <label>Загрузить скриншот</label>
    <input type="file" id="upload" accept="image/*">
    <div id="ocrStatus" class="small">Ожидание загрузки...</div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Длина матча</label>
        <select id="matchLen">
          <option value="48">NBA - 48</option>
          <option value="40">Other - 40</option>
          <option value="16">Кибербаскет 4×4 (16)</option>
          <option value="20">Кибербаскет 4×5 (20)</option>
          <option value="custom">Своя...</option>
        </select>
        <input id="customLen" type="number" min="1" step="1" style="display:none;margin-top:6px" placeholder="Минуты" inputmode="numeric" />
      </div>

      <div class="col">
        <label>Прогресс матча</label>
        <div class="inline">
          <input id="progressPct" type="number" min="0" max="100" step="0.1" value="30" inputmode="decimal" />
          <span class="muted">%</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Текущий темп (очки/мин)</label>
        <input id="tempoNow" type="number" step="0.01" value="5.01" inputmode="decimal" />
      </div>

      <div class="col">
        <label>Средний темп лиги</label>
        <input id="tempoLeague" type="number" step="0.01" value="2.00" inputmode="decimal" />
      </div>
    </div>

    <div class="row full-width">
      <label>Вес текущего темпа</label>
      <div class="inline">
        <input id="weight" type="range" min="0" max="100" value="50" />
        <div style="width:40px; text-align:center; font-size:14px;" id="wtLabel">50%</div>
      </div>
      <div class="small">0% = лига, 100% = текущий темп</div>
    </div>

    <div class="row">
      <div class="col">
        <label>Линия букмекера</label>
        <input id="bookLine" type="number" step="0.1" placeholder="Напр. 190" inputmode="decimal" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <button class="btn" id="calcBtn">Посчитать</button>
      </div>
      <div class="col">
        <button class="btn secondary" id="copyBtn">Скопировать итог</button>
      </div>
    </div>

    <div class="result" id="out">
      <div class="grid">
        <div class="scenario">
          <div class="muted">Минут сыграно</div>
          <div class="big" id="minsPlayed">—</div>
          <div class="muted">Очки сейчас</div>
          <div id="pointsNow" class="big">—</div>
          <div class="muted">Минут осталось</div>
          <div id="minsLeft" class="big">—</div>
        </div>

        <div class="scenario">
          <div class="muted">Проекция (оставшиеся минуты)</div>
          <div class="muted">По текущему темпу</div>
          <div class="big" id="projNow">—</div>
          <div class="muted">По среднему темпу</div>
          <div class="big" id="projLeague">—</div>
        </div>

        <div class="scenario">
          <div class="muted">Ожидаемый тотал</div>
          <div class="muted">(текущий темп)</div>
          <div class="big" id="expNow">—</div>
          <div class="muted">(лига)</div>
          <div class="big" id="expLeague">—</div>
        </div>

        <div class="scenario">
          <div class="muted">Смешанный прогноз</div>
          <div class="big" id="expMixed">—</div>
          <div class="muted">Вес текущего темпа</div>
          <div class="big" id="wtEcho">—</div>
        </div>
      </div>

      <div id="bookCompare" class="muted" style="margin-top:8px; font-size:13px;">Линия: —</div>
    </div>

    <div class="small" style="margin-top:8px;">Примечание: если текущая эффективность аномальная, обычно имеет смысл смягчать прогноз (двигать ползунок в сторону среднего).</div>
  </div>

  <footer>Сделано для быстрой оценки. Ответственность за ставки — на вас.</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
<script>
(function(){
  function toggleTheme() {
    const body = document.body;
    const isLight = body.classList.contains('light-theme');
    const themeToggle = document.getElementById('themeToggle');
    if (isLight) {
      body.classList.remove('light-theme');
      themeToggle.textContent = 'Светлая тема';
      localStorage.setItem('theme', 'dark');
    } else {
      body.classList.add('light-theme');
      themeToggle.textContent = 'Темная тема';
      localStorage.setItem('theme', 'light');
    }
  }
  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const themeToggle = document.getElementById('themeToggle');
    if (savedTheme === 'light') {
      document.body.classList.add('light-theme');
      themeToggle.textContent = 'Темная тема';
    } else {
      document.body.classList.remove('light-theme');
      themeToggle.textContent = 'Светлая тема';
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    initTheme();
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    const matchLen = document.getElementById('matchLen');
    const customLen = document.getElementById('customLen');
    matchLen.addEventListener('change', function() {
      if (this.value === 'custom') {
        customLen.style.display = 'block';
      } else {
        customLen.style.display = 'none';
      }
    });
  });

  const matchLen = document.getElementById('matchLen');
  const customLen = document.getElementById('customLen');
  const progressPct = document.getElementById('progressPct');
  const tempoNow = document.getElementById('tempoNow');
  const tempoLeague = document.getElementById('tempoLeague');
  const weight = document.getElementById('weight');
  const wtLabel = document.getElementById('wtLabel');
  const bookLine = document.getElementById('bookLine');
  const minsPlayedEl = document.getElementById('minsPlayed');
  const pointsNowEl = document.getElementById('pointsNow');
  const minsLeftEl = document.getElementById('minsLeft');
  const projNowEl = document.getElementById('projNow');
  const projLeagueEl = document.getElementById('projLeague');
  const expNowEl = document.getElementById('expNow');
  const expLeagueEl = document.getElementById('expLeague');
  const expMixedEl = document.getElementById('expMixed');
  const wtEcho = document.getElementById('wtEcho');
  const bookCompare = document.getElementById('bookCompare');

  function num(x){ return Number(x) || 0; }
  function r(x){ return Math.round(x*10)/10; }

  function calculate(){
    let totalMinutes = (matchLen.value === 'custom') ? num(customLen.value) : num(matchLen.value);
    if(totalMinutes <= 0) totalMinutes = 48;
    let progressPercent = num(progressPct.value);
    if(progressPercent < 0) progressPercent = 0;
    if(progressPercent > 100) progressPercent = 100;

    const minsPlayed = totalMinutes * (progressPercent/100);
    const tNow = num(tempoNow.value);
    const tLeague = num(tempoLeague.value);
    const ptsNow = tNow * minsPlayed;
    const minsLeft = Math.max(0, totalMinutes - minsPlayed);

    const projNow = tNow * minsLeft;
    const projLeague = tLeague * minsLeft;
    const expNow = ptsNow + projNow;
    const expLeague = ptsNow + projLeague;

    const w = num(weight.value)/100;
    const mixedTempo = tNow * w + tLeague * (1 - w);
    const projMixed = mixedTempo * minsLeft;
    const expMixed = ptsNow + projMixed;

    minsPlayedEl.textContent = r(minsPlayed) + ' мин';
    pointsNowEl.textContent = r(ptsNow) + ' очк';
    minsLeftEl.textContent = r(minsLeft) + ' мин';
    projNowEl.textContent = r(projNow);
    projLeagueEl.textContent = r(projLeague);
    expNowEl.textContent = r(expNow);
    expLeagueEl.textContent = r(expLeague);
    expMixedEl.textContent = r(expMixed);
    wtEcho.textContent = Math.round(w*100) + '% (темп=' + r(mixedTempo) + ')';

    const line = num(bookLine.value);
    if(line > 0){
      const diff = r(expMixed - line);
      let verdict = '';
      if(Math.abs(diff) < 2){
        verdict = `Линия ${line}. Прогноз ≈ ${r(expMixed)} (≈ совпадает).`;
      } else if(diff > 0){
        verdict = `Линия ${line}. Прогноз ≈ ${r(expMixed)} — ценность на ТБ (+${diff}).`;
      } else {
        verdict = `Линия ${line}. Прогноз ≈ ${r(expMixed)} — ценность на ТМ (${diff}).`;
      }
      bookCompare.textContent = verdict;
    } else {
      bookCompare.textContent = 'Линия: —';
    }
  }

  document.getElementById('calcBtn').addEventListener('click', calculate);
  weight.addEventListener('input', function(){
    wtLabel.textContent = weight.value + '%';
  });
  document.getElementById('copyBtn').addEventListener('click', function(){
    let text = 
      `Ожидание по темпу: ${expNowEl.textContent}\n` +
      `Ожидание по лиге: ${expLeagueEl.textContent}\n` +
      `Смешанный прогноз: ${expMixedEl.textContent}\n` +
      bookCompare.textContent;
    navigator.clipboard.writeText(text);
  });

  const upload = document.getElementById('upload');
  const ocrStatus = document.getElementById('ocrStatus');
  upload.addEventListener('change', async function(){
    const file = this.files[0];
    if(!file) return;
    ocrStatus.textContent = 'Распознаём...';
    try {
      const { data: { text } } = await Tesseract.recognize(file, 'rus+eng', {
        tessedit_char_whitelist: '0123456789: x×абвгдежзийклмнопрстуфхцчшщъыьэюяabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ()-. ',
        tessedit_pageseg_mode: Tesseract.PSM.AUTO,
        tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
      });
      ocrStatus.textContent = 'Готово. Извлечение данных...';
      console.log("Extracted OCR text:", text); // Для отладки
      parseOCR(text);
    } catch(err){
      console.error("OCR Error:", err);
      ocrStatus.textContent = 'Ошибка OCR: ' + err.message;
    }
  });

  function parseOCR(text){
    console.log("Processing OCR text:", text);

    // Формат матча (поддержка "x" и "×")
    if(/4\s*[x×]\s*4/.test(text)){
      matchLen.value = '16';
    } else if(/4\s*[x×]\s*5/.test(text) || /2x10\s*мин/i.test(text)){
      matchLen.value = '20';
    }

    // Определение части матча и времени
    let partNum = null;
    let numParts = 4; // по умолчанию четверти
    const quarterMatch = text.match(/(\d+)\s*(четв|чверт|четверт|кварт|quarter)/i);
    if (quarterMatch) {
      partNum = parseInt(quarterMatch[1], 10);
      numParts = 4;
    } else {
      const halfMatch = text.match(/(\d+)\s*(полов|half)/i);
      if (halfMatch) {
        partNum = parseInt(halfMatch[1], 10);
        numParts = 2;
      }
    }

    let timeLeftMin = 0;
    let timeLeftSec = 0;
    const timeMatch = text.match(/(?:время|time|осталось|clock)\s*[:\-]?\s*(\d{1,2}):(\d{2})/i) || text.match(/(\d{1,2}):(\d{2})/i);
    if (timeMatch) {
      timeLeftMin = parseInt(timeMatch[1], 10);
      timeLeftSec = parseInt(timeMatch[2], 10);
    }

    // Расчет прогресса
    if (partNum !== null || timeMatch) {
      let totalMinutes = num(matchLen.value);
      if (totalMinutes <= 0) totalMinutes = 20; // По умолчанию 20 для 2x10
      if (timeMatch) {
        const periodLength = totalMinutes / numParts;
        const timeLeft = timeLeftMin + timeLeftSec / 60;
        const elapsedInPeriod = periodLength - timeLeft;
        let minsPlayed = 0;
        if (partNum) {
          minsPlayed = (partNum - 1) * periodLength + elapsedInPeriod;
        } else {
          minsPlayed = totalMinutes - (timeLeftMin + timeLeftSec / 60);
        }
        const progress = (minsPlayed / totalMinutes) * 100;
        progressPct.value = r(progress);
      }
    }

    // Счёт (улучшенное извлечение)
    const scoreLines = text.split('\n').filter(line => /\d+\s+\d+/.test(line)); // Ищем строки с двумя числами
    if (scoreLines.length > 0) {
      const lastScoreLine = scoreLines[scoreLines.length - 1];
      const scoreMatch = lastScoreLine.match(/(\d+)\s+(\d+)/); // Два числа через пробел
      if (scoreMatch) {
        const team1Score = parseInt(scoreMatch[1], 10);
        const team2Score = parseInt(scoreMatch[2], 10);
        console.log("Extracted scores - Team 1:", team1Score, "Team 2:", team2Score);
        const totalPoints = team1Score + team2Score;
        const minsPlayed = num(matchLen.value) * (num(progressPct.value)/100);
        if (minsPlayed > 0) {
          tempoNow.value = r(totalPoints / minsPlayed);
        }
      } else {
        console.log("No valid score format found in:", lastScoreLine);
      }
    }

    // Линия букмекера
    let lineMatch = text.match(/Т[БМ]\s*\(?(\d+[.,]?\d*)\)?/i);
    if(lineMatch){
      bookLine.value = lineMatch[1].replace(',', '.');
    }

    ocrStatus.textContent = 'Данные заполнены из OCR.';
    calculate(); // Автоматически пересчитать после OCR
  }

})();
</script>
</body>
</html>
